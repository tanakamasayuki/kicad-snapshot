# KiCad Snapshot --- 仕様書

## 概要

**KiCad Snapshot** は、KiCadプロジェクトのバックアップと
視覚的な差分比較を行うオープンソースツールである。

KiCadの内蔵アーカイブ機能と同じルールでKiCadプロジェクトの
ZIPスナップショットを作成し、過去と現在の状態を視覚的に比較できる。

Gitは必須ではない。コアのワークフローは、Gitを使わない一般のKiCadユーザー向けに設計する。

------------------------------------------------------------------------

## 目標

-   KiCadプロジェクト変更の視覚的比較を提供する
-   Gitの知識を必要としない
-   自動で履歴を作成しない
-   明示的なユーザー操作でのみデータを保存する
-   比較結果は一時的とし、永続キャッシュを持たない

------------------------------------------------------------------------

## 対応KiCadバージョン

-   Windows / macOS / Linux
-   最低 KiCad 8 以上
-   可能であれば下位バージョンも対応
-   外部 `kicad-cli` を使用
-   検出優先順位:
    -   手動設定パス（最優先）
    -   想定されるインストール先
    -   PATH
-   複数候補が見つかった場合は最新の `kicad-cli` を既定で使用
-   `kicad-cli --version` でバージョン確認を行う
-   自動検出した `kicad-cli` パスを画面に表示し、手動変更できる
-   変更内容は保存する
-   プロジェクトファイルの保存やアップグレードは行わない（非破壊設計）

------------------------------------------------------------------------

## コア機能

### 1. スナップショット（ZIPバックアップ）

-   include + exclude のハイブリッド規則でZIPアーカイブを作成
-   含めるもの:
    -   `*.kicad_*`（例: `.kicad_pro`, `.kicad_sch`, `.kicad_pcb`, `.kicad_prl`）
    -   `*-lib-table`（例: `fp-lib-table`, `sym-lib-table`, `design-block-lib-table`）
-   除外（安全性/性能のため）:
    -   `.git/`, `.venv/`, `__pycache__/`, `node_modules/`
    -   `*.zip`, `*.log`, `*.tmp`, `*.bak`, `*.cache`

参考（KiCad標準バックアップ）:

-   KiCadは、変更後に「前回バックアップから5分以上経過」している場合、
    自動バックアップを作成する
-   25世代を超える古いバックアップは自動削除される
-   世代数や自動バックアップ間隔はKiCad設定で変更できる

### 2. 差分比較

対応比較:

-   ZIP 対 現在
-   ZIP 対 ZIP
-   （任意）Gitコミット 対 現在

内部モデル:

すべての比較は一時展開ディレクトリ間で行う。

    入力A → 一時展開
    入力B → 一時展開
    ↓
    kicad-cli export
    ↓
    画像差分生成
    ↓
    一時データの削除

永続キャッシュは保存しない。

### 3. ビジュアル差分

#### 回路図

-   `kicad-cli sch export svg` によるSVG出力
-   シートごとに比較

#### PCB

-   `kicad-cli pcb export svg` によるSVG出力
-   Topレイヤービュー
-   Bottomレイヤービュー

UI比較モード: - A/B切替 - 差分ハイライト - （任意）スライダー比較

差分生成: レンダリング結果のピクセル差分。

### 4. 差分レポート出力

生成内容:

    diff_report/
      diff_sch_<sheet>.png
      diff_pcb_top.png
      diff_pcb_bottom.png
      comment.md

既定の出力先は比較対象のプロジェクトフォルダ。ユーザーが変更できる。

ユーザーが手動で画像とMarkdownを必要に応じて共有する。

自動投稿は行わない。

------------------------------------------------------------------------

## UX原則

-   比較は一時的
-   履歴は明示的
-   自動バックグラウンドスナップショットはしない
-   サイレントにファイルを変更しない
-   非破壊動作
-   `kicad-cli` 自動検出は透明性を持ち、ユーザーが上書き可能

------------------------------------------------------------------------

## 設定の保存先

プロジェクトフォルダは前提としない。ユーザー設定は
`platformdirs` のユーザー設定ディレクトリ（`user_config_dir` など）に保存する。

------------------------------------------------------------------------

## できること

-   ZIPスナップショットの作成
-   スナップショットの視覚的比較
-   スナップショットと現在の比較
-   差分レポート用アセット生成
-   任意でのGit連携

------------------------------------------------------------------------

## しないこと

-   自動バックアップ
-   永続キャッシュ
-   KiCadプロジェクトファイルの変更
-   Git高度操作（rebase/merge UI）
-   画像の自動アップロード

------------------------------------------------------------------------

## UI構成（最小）

### 画面1 -- CLI / プロジェクト

-   自動検出した `kicad-cli` パスを表示
-   見つからない/不正な場合はパス選択を促す
-   `kicad-cli --version` が確認できない場合は次画面に進まない
-   最近使ったプロジェクトから選択、または新規で開く

### 画面2 -- スナップショット一覧

-   スナップショット一覧
-   現在との差分比較
-   スナップショット同士の比較

### 画面3 -- 差分ビューア

-   回路図タブ
-   PCBタブ
-   差分レポート用アセット生成

------------------------------------------------------------------------

## ブランディング

**名称:** KiCad Snapshot\
**リポジトリ:** kicad-snapshot

タグライン:

> KiCadプロジェクトのスナップショット --- 視覚的バックアップ & 差分ビューア
